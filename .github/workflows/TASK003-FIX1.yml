name: TASK003-FIX1 - Disable native validation, UA-only validation

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  task003_fix1:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Apply TASK003-FIX1 changes
        run: |
          mkdir -p pages/employer/jobs/[id] pages/employer

          # -----------------------------
          # pages/employer/company.vue
          # -----------------------------
          cat <<'EOF' > pages/employer/company.vue
          <script setup lang="ts">
          const saving = ref(false)
          const saved = ref(false)
          const error = ref<string | null>(null)

          const form = reactive({
            name: '',
            city: '',
            website: '',
            description: '',
            industry: '',
            staffCount: null as number | null
          })

          const initial = ref({
            name: '',
            city: '',
            website: '',
            description: '',
            industry: '',
            staffCount: null as number | null
          })

          const fieldErrors = reactive<Record<string, string>>({
            name: '',
            website: '',
            staffCount: ''
          })

          const clearFieldErrors = () => {
            fieldErrors.name = ''
            fieldErrors.website = ''
            fieldErrors.staffCount = ''
          }

          const normalizeUrl = (url: string) => url.trim()

          const validate = () => {
            clearFieldErrors()
            let ok = true

            if (!form.name.trim()) {
              fieldErrors.name = 'Вкажіть назву компанії'
              ok = false
            }

            if (form.website) {
              const u = normalizeUrl(form.website)
              // дозволяємо тільки http/https
              if (!/^https?:\/\/.+/i.test(u)) {
                fieldErrors.website = 'Вкажіть коректне посилання (наприклад, https://company.com)'
                ok = false
              }
            }

            if (form.staffCount !== null) {
              const n = Number(form.staffCount)
              if (Number.isNaN(n) || n < 1) {
                fieldErrors.staffCount = 'Кількість співробітників має бути числом від 1'
                ok = false
              }
            }

            return ok
          }

          const { data, error: fetchError } = await useFetch('/api/company')

          const applyFromServer = (src: any) => {
            form.name = src?.name || ''
            form.city = src?.city || ''
            form.website = src?.website || ''
            form.description = src?.description || ''
            form.industry = src?.industry || ''
            form.staffCount = src?.staffCount ?? null

            initial.value = {
              name: form.name,
              city: form.city,
              website: form.website,
              description: form.description,
              industry: form.industry,
              staffCount: form.staffCount
            }
          }

          if (data.value) applyFromServer(data.value)

          const hasChanges = computed(() => {
            const a = initial.value
            return (
              form.name !== a.name ||
              form.city !== a.city ||
              form.website !== a.website ||
              form.description !== a.description ||
              form.industry !== a.industry ||
              (form.staffCount ?? null) !== (a.staffCount ?? null)
            )
          })

          watch(
            () => ({ ...form }),
            () => {
              if (saved.value) saved.value = false
            },
            { deep: true }
          )

          const submit = async () => {
            error.value = null
            saved.value = false

            if (!validate()) {
              error.value = 'Перевірте поля форми'
              return
            }
            if (!hasChanges.value) return

            saving.value = true
            try {
              const updated: any = await $fetch('/api/company', {
                method: 'PUT',
                body: form
              })
              applyFromServer(updated)
              saved.value = true
              setTimeout(() => (saved.value = false), 2000)
            } catch (e: any) {
              error.value = e?.data?.statusMessage || 'Не вдалося зберегти профіль компанії'
            } finally {
              saving.value = false
            }
          }
          </script>

          <template>
            <section class="max-w-xl space-y-4">
              <h1 class="text-lg font-semibold text-primary">Профіль компанії</h1>

              <p class="text-xs text-muted">
                Дані компанії відображаються у вакансіях і допомагають пошукачам краще вас зрозуміти.
              </p>

              <div v-if="fetchError" class="text-xs text-red-500">
                {{ fetchError.data?.statusMessage || 'Помилка завантаження профілю компанії' }}
              </div>

              <div v-if="error" class="text-xs text-red-500">
                {{ error }}
              </div>

              <!-- novalidate: вимикає браузерні англ. підказки -->
              <form
                v-if="!fetchError"
                novalidate
                @submit.prevent="submit"
                class="space-y-3 bg-white p-4 rounded-2xl border border-slate-200"
              >
                <div class="space-y-1">
                  <label class="text-xs text-muted">Назва компанії</label>
                  <input
                    v-model="form.name"
                    type="text"
                    aria-required="true"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.name" class="text-[11px] text-red-500">{{ fieldErrors.name }}</p>
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Місто</label>
                  <input
                    v-model="form.city"
                    type="text"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Сайт або лінк</label>
                  <input
                    v-model="form.website"
                    type="text"
                    inputmode="url"
                    placeholder="https://company.com"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.website" class="text-[11px] text-red-500">{{ fieldErrors.website }}</p>
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Сфера діяльності</label>
                  <input
                    v-model="form.industry"
                    type="text"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Кількість співробітників (опційно)</label>
                  <input
                    v-model.number="form.staffCount"
                    type="number"
                    min="1"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.staffCount" class="text-[11px] text-red-500">{{ fieldErrors.staffCount }}</p>
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Опис компанії</label>
                  <textarea
                    v-model="form.description"
                    rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                </div>

                <div class="pt-1">
                  <button
                    v-if="hasChanges && !saved"
                    type="submit"
                    :disabled="saving"
                    class="w-full text-sm px-4 py-2 rounded-xl bg-accent text-white font-medium hover:opacity-90 disabled:opacity-60"
                  >
                    {{ saving ? 'Збереження...' : 'Зберегти' }}
                  </button>

                  <div
                    v-else-if="saved"
                    class="w-full text-sm px-4 py-2 rounded-xl bg-emerald-50 text-emerald-700 font-medium text-center border border-emerald-200"
                  >
                    Збережено ✓
                  </div>
                </div>
              </form>
            </section>
          </template>
          EOF

          # ------------------------------------------
          # pages/employer/jobs/[id]/edit.vue
          # ------------------------------------------
          cat <<'EOF' > pages/employer/jobs/[id]/edit.vue
          <script setup lang="ts">
          const route = useRoute()
          const id = route.params.id as string

          const error = ref<string | null>(null)
          const saving = ref(false)

          const fieldErrors = reactive<Record<string, string>>({
            title: '',
            salary: '',
            tags: ''
          })

          const clearFieldErrors = () => {
            fieldErrors.title = ''
            fieldErrors.salary = ''
            fieldErrors.tags = ''
          }

          const form = reactive({
            title: '',
            city: '',
            workFormat: 'office',
            employmentType: 'full-time',
            salaryFrom: null as number | null,
            salaryTo: null as number | null,
            description: '',
            requirements: '',
            conditions: '',
            tags: '' as string,
            status: 'active'
          })

          const validate = () => {
            clearFieldErrors()
            let ok = true

            if (!form.title.trim()) {
              fieldErrors.title = 'Вкажіть назву посади'
              ok = false
            }

            if (form.salaryFrom !== null && form.salaryFrom < 0) {
              fieldErrors.salary = 'Зарплата "від" не може бути відʼємною'
              ok = false
            }
            if (form.salaryTo !== null && form.salaryTo < 0) {
              fieldErrors.salary = 'Зарплата "до" не може бути відʼємною'
              ok = false
            }
            if (form.salaryFrom !== null && form.salaryTo !== null && form.salaryFrom > form.salaryTo) {
              fieldErrors.salary = 'Зарплата "від" не може бути більшою за "до"'
              ok = false
            }

            const tagArr = form.tags.split(',').map(t => t.trim()).filter(Boolean)
            if (tagArr.some(t => t.length > 24)) {
              fieldErrors.tags = 'Окремий тег не має перевищувати 24 символи'
              ok = false
            }

            return ok
          }

          const { data, error: fetchError } = await useFetch(`/api/jobs/${id}`)

          if (data.value) {
            form.title = data.value.title || ''
            form.city = data.value.city || ''
            form.workFormat = data.value.workFormat || 'office'
            form.employmentType = data.value.employmentType || 'full-time'
            form.salaryFrom = data.value.salaryFrom ?? null
            form.salaryTo = data.value.salaryTo ?? null
            form.description = data.value.description || ''
            form.requirements = data.value.requirements || ''
            form.conditions = data.value.conditions || ''
            form.status = data.value.status || 'active'
            form.tags = (data.value.tags || []).join(', ')
          }

          const submit = async () => {
            error.value = null
            if (!validate()) {
              error.value = 'Перевірте поля форми'
              return
            }

            saving.value = true
            try {
              await $fetch(`/api/jobs/${id}`, {
                method: 'PUT',
                body: {
                  ...form,
                  tags: form.tags.split(',').map(t => t.trim()).filter(Boolean)
                }
              })
              await navigateTo('/employer/jobs')
            } catch (e: any) {
              error.value = e?.data?.statusMessage || 'Не вдалося зберегти вакансію'
            } finally {
              saving.value = false
            }
          }
          </script>

          <template>
            <section class="max-w-xl space-y-4">
              <h1 class="text-lg font-semibold text-primary">Редагування вакансії</h1>

              <div v-if="fetchError" class="text-xs text-red-500">
                {{ fetchError.data?.statusMessage || 'Помилка завантаження вакансії' }}
              </div>
              <div v-if="error" class="text-xs text-red-500">
                {{ error }}
              </div>

              <!-- novalidate -->
              <form
                v-if="!fetchError"
                novalidate
                @submit.prevent="submit"
                class="space-y-3 bg-white p-4 rounded-2xl border border-slate-200"
              >
                <div class="space-y-1">
                  <label class="text-xs text-muted">Посада</label>
                  <input
                    v-model="form.title"
                    type="text"
                    aria-required="true"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.title" class="text-[11px] text-red-500">{{ fieldErrors.title }}</p>
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Місто</label>
                  <input
                    v-model="form.city"
                    type="text"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                </div>

                <div class="grid grid-cols-2 gap-3 text-xs">
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Формат роботи</label>
                    <select
                      v-model="form.workFormat"
                      class="w-full px-3 py-2 border rounded-xl outline-none focus:border-accent text-xs"
                    >
                      <option value="office">Офіс</option>
                      <option value="remote">Remote</option>
                      <option value="hybrid">Hybrid</option>
                    </select>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Тип зайнятості</label>
                    <select
                      v-model="form.employmentType"
                      class="w-full px-3 py-2 border rounded-xl outline-none focus:border-accent text-xs"
                    >
                      <option value="full-time">Повна</option>
                      <option value="part-time">Часткова</option>
                      <option value="freelance">Фріланс</option>
                    </select>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Зарплата від</label>
                    <input
                      v-model.number="form.salaryFrom"
                      type="number"
                      min="0"
                      class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                    />
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Зарплата до</label>
                    <input
                      v-model.number="form.salaryTo"
                      type="number"
                      min="0"
                      class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                    />
                  </div>
                </div>
                <p v-if="fieldErrors.salary" class="text-[11px] text-red-500">{{ fieldErrors.salary }}</p>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Опис</label>
                  <textarea v-model="form.description" rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent" />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Вимоги</label>
                  <textarea v-model="form.requirements" rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent" />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Умови</label>
                  <textarea v-model="form.conditions" rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent" />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Теги (через кому)</label>
                  <input
                    v-model="form.tags"
                    type="text"
                    placeholder="Frontend, Junior, Remote"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.tags" class="text-[11px] text-red-500">{{ fieldErrors.tags }}</p>
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Статус вакансії</label>
                  <select
                    v-model="form.status"
                    class="w-full px-3 py-2 border rounded-xl outline-none focus:border-accent text-xs"
                  >
                    <option value="active">Активна</option>
                    <option value="inactive">Неактивна</option>
                  </select>
                </div>

                <button
                  type="submit"
                  :disabled="saving"
                  class="w-full text-sm px-4 py-2 rounded-xl bg-accent text-white font-medium hover:opacity-90 disabled:opacity-60"
                >
                  {{ saving ? 'Збереження...' : 'Зберегти' }}
                </button>
              </form>
            </section>
          </template>
          EOF

          # ------------------------------------------
          # pages/employer/job-create.vue
          # ------------------------------------------
          cat <<'EOF' > pages/employer/job-create.vue
          <script setup lang="ts">
          const form = reactive({
            title: '',
            city: '',
            workFormat: 'office',
            employmentType: 'full-time',
            salaryFrom: null as number | null,
            salaryTo: null as number | null,
            description: '',
            requirements: '',
            conditions: '',
            tags: '' as string,
            status: 'active'
          })

          const error = ref<string | null>(null)
          const saving = ref(false)

          const fieldErrors = reactive<Record<string, string>>({
            title: '',
            salary: '',
            tags: ''
          })

          const clearFieldErrors = () => {
            fieldErrors.title = ''
            fieldErrors.salary = ''
            fieldErrors.tags = ''
          }

          const validate = () => {
            clearFieldErrors()
            let ok = true

            if (!form.title.trim()) {
              fieldErrors.title = 'Вкажіть назву посади'
              ok = false
            }

            if (form.salaryFrom !== null && form.salaryFrom < 0) {
              fieldErrors.salary = 'Зарплата "від" не може бути відʼємною'
              ok = false
            }
            if (form.salaryTo !== null && form.salaryTo < 0) {
              fieldErrors.salary = 'Зарплата "до" не може бути відʼємною'
              ok = false
            }
            if (form.salaryFrom !== null && form.salaryTo !== null && form.salaryFrom > form.salaryTo) {
              fieldErrors.salary = 'Зарплата "від" не може бути більшою за "до"'
              ok = false
            }

            const tagArr = form.tags.split(',').map(t => t.trim()).filter(Boolean)
            if (tagArr.some(t => t.length > 24)) {
              fieldErrors.tags = 'Окремий тег не має перевищувати 24 символи'
              ok = false
            }

            return ok
          }

          const submit = async () => {
            error.value = null
            if (!validate()) {
              error.value = 'Перевірте поля форми'
              return
            }

            saving.value = true
            try {
              await $fetch('/api/jobs', {
                method: 'POST',
                body: {
                  ...form,
                  tags: form.tags.split(',').map(t => t.trim()).filter(Boolean)
                }
              })
              await navigateTo('/employer/jobs')
            } catch (e: any) {
              error.value = e?.data?.statusMessage || 'Не вдалося створити вакансію'
            } finally {
              saving.value = false
            }
          }
          </script>

          <template>
            <section class="max-w-xl space-y-4">
              <h1 class="text-lg font-semibold text-primary">Нова вакансія</h1>

              <div v-if="error" class="text-xs text-red-500">
                {{ error }}
              </div>

              <!-- novalidate -->
              <form
                novalidate
                @submit.prevent="submit"
                class="space-y-3 bg-white p-4 rounded-2xl border border-slate-200"
              >
                <div class="space-y-1">
                  <label class="text-xs text-muted">Посада</label>
                  <input
                    v-model="form.title"
                    type="text"
                    aria-required="true"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.title" class="text-[11px] text-red-500">{{ fieldErrors.title }}</p>
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Місто</label>
                  <input
                    v-model="form.city"
                    type="text"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                </div>

                <div class="grid grid-cols-2 gap-3 text-xs">
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Формат роботи</label>
                    <select
                      v-model="form.workFormat"
                      class="w-full px-3 py-2 border rounded-xl outline-none focus:border-accent text-xs"
                    >
                      <option value="office">Офіс</option>
                      <option value="remote">Remote</option>
                      <option value="hybrid">Hybrid</option>
                    </select>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Тип зайнятості</label>
                    <select
                      v-model="form.employmentType"
                      class="w-full px-3 py-2 border rounded-xl outline-none focus:border-accent text-xs"
                    >
                      <option value="full-time">Повна</option>
                      <option value="part-time">Часткова</option>
                      <option value="freelance">Фріланс</option>
                    </select>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Зарплата від</label>
                    <input
                      v-model.number="form.salaryFrom"
                      type="number"
                      min="0"
                      class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                    />
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs text-muted">Зарплата до</label>
                    <input
                      v-model.number="form.salaryTo"
                      type="number"
                      min="0"
                      class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                    />
                  </div>
                </div>
                <p v-if="fieldErrors.salary" class="text-[11px] text-red-500">{{ fieldErrors.salary }}</p>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Опис</label>
                  <textarea v-model="form.description" rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent" />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Вимоги</label>
                  <textarea v-model="form.requirements" rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent" />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Умови</label>
                  <textarea v-model="form.conditions" rows="3"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent" />
                </div>

                <div class="space-y-1">
                  <label class="text-xs text-muted">Теги (через кому)</label>
                  <input
                    v-model="form.tags"
                    type="text"
                    placeholder="Frontend, Junior, Remote"
                    class="w-full text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                  />
                  <p v-if="fieldErrors.tags" class="text-[11px] text-red-500">{{ fieldErrors.tags }}</p>
                </div>

                <button
                  type="submit"
                  :disabled="saving"
                  class="w-full text-sm px-4 py-2 rounded-xl bg-accent text-white font-medium hover:opacity-90 disabled:opacity-60"
                >
                  {{ saving ? 'Збереження...' : 'Створити' }}
                </button>
              </form>
            </section>
          </template>
          EOF

      - name: Commit and push TASK003-FIX1
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pages/employer/company.vue pages/employer/jobs/[id]/edit.vue pages/employer/job-create.vue
          git commit -m "TASK003-FIX1: disable native validation, UA-only validation" || echo "No changes to commit"
          git push
