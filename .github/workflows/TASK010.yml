name: TASK010 - Favorites show company name and phone + shared JobCard

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  task010:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add JobCard component
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p components

          cat > components/JobCard.vue <<'EOF'
          <script setup lang="ts">
          type Job = {
            _id: string
            title?: string
            city?: string
            employmentType?: string
            workFormat?: string
            salaryFrom?: number | string | null
            salaryTo?: number | string | null
            description?: string
            companyName?: string
            companyPhone?: string
          }
          
          const props = defineProps<{
            job: Job
            showDescription?: boolean
          }>()
          
          const showDescription = computed(() => props.showDescription ?? true)
          
          const salaryText = computed(() => {
            const from = props.job.salaryFrom
            const to = props.job.salaryTo
            if (from || to) return `${from || '—'}–${to || '—'} ₴`
            return ''
          })
          </script>
          
          <template>
            <article class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-accent transition flex flex-col gap-2">
              <div class="flex justify-between gap-4 items-start">
                <div class="min-w-0">
                  <NuxtLink :to="`/jobs/${job._id}`" class="text-base font-semibold text-primary hover:text-accent">
                    {{ job.title || 'Без назви' }}
                  </NuxtLink>
          
                  <p class="text-xs text-muted mt-1">
                    {{ job.city || 'Місто не вказано' }}
                    <template v-if="job.employmentType"> · {{ job.employmentType }}</template>
                    <template v-if="job.workFormat"> · {{ job.workFormat }}</template>
                  </p>
          
                  <p v-if="job.companyName || job.companyPhone" class="text-xs text-slate-700 mt-1">
                    <span v-if="job.companyName" class="font-medium">{{ job.companyName }}</span>
                    <span v-if="job.companyName && job.companyPhone"> · </span>
                    <span v-if="job.companyPhone">{{ job.companyPhone }}</span>
                  </p>
                  <p v-else class="text-xs text-muted mt-1">Компанія: не вказано</p>
                </div>
          
                <div class="text-right text-sm text-primary font-medium whitespace-nowrap">
                  <span v-if="salaryText">{{ salaryText }}</span>
                  <span v-else class="text-muted text-xs">Зарплата не вказана</span>
                </div>
              </div>
          
              <p v-if="showDescription && job.description" class="text-xs text-slate-600">
                {{ job.description }}
              </p>
            </article>
          </template>
          EOF

      - name: Update jobs list page to use JobCard
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p pages/jobs

          cat > pages/jobs/index.vue <<'EOF'
          <script setup lang="ts">
          import JobCard from '~/components/JobCard.vue'
          
          const term = ref('')
          const city = ref('')
          
          const { data: jobs, refresh } = await useFetch('/api/jobs', {
            query: { term, city }
          })
          
          const search = async () => {
            await refresh()
          }
          </script>
          
          <template>
            <section class="space-y-6">
              <div>
                <h1 class="text-2xl font-semibold text-primary">Вакансії</h1>
                <p class="text-sm text-muted mt-1">Знайдіть роботу або перегляньте актуальні пропозиції.</p>
              </div>
          
              <div class="grid gap-3 md:grid-cols-4 items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                <input
                  v-model="term"
                  type="text"
                  placeholder="Посада або ключові слова"
                  class="md:col-span-2 text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                />
                <input
                  v-model="city"
                  type="text"
                  placeholder="Місто"
                  class="text-sm px-3 py-2 border rounded-xl outline-none focus:border-accent"
                />
                <button
                  @click="search"
                  class="text-sm px-4 py-2 rounded-xl bg-accent text-white font-medium hover:opacity-90"
                >
                  Пошук
                </button>
              </div>
          
              <div class="space-y-3">
                <div v-if="!jobs?.length" class="text-sm text-muted">
                  За введеними критеріями для пошуку вакансій поки немає
                </div>
          
                <JobCard v-for="job in jobs" :key="job._id" :job="job" :show-description="true" />
              </div>
            </section>
          </template>
          EOF

      - name: Update favorites page to show company data and use JobCard
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p pages

          cat > pages/favorites.vue <<'EOF'
          <script setup lang="ts">
          import JobCard from '~/components/JobCard.vue'
          
          type Job = {
            _id: string
            title?: string
            city?: string
            employmentType?: string
            workFormat?: string
            salaryFrom?: number | string | null
            salaryTo?: number | string | null
            description?: string
            companyName?: string
            companyPhone?: string
          }
          
          const { $notify } = useNuxtApp()
          
          const { data: favorites, refresh, pending, error } = await useFetch<Job[]>('/api/favorites')
          
          const items = ref<Job[]>([])
          
          const enrichWithCompany = async (list: Job[]) => {
            if (!Array.isArray(list) || list.length === 0) {
              items.value = []
              return
            }
          
            const enriched = await Promise.all(
              list.map(async (j) => {
                try {
                  const full: any = await $fetch(`/api/jobs/${j._id}`)
                  return {
                    ...j,
                    companyName: full?.companyName || j.companyName || '',
                    companyPhone: full?.companyPhone || j.companyPhone || ''
                  }
                } catch {
                  return j
                }
              })
            )
          
            items.value = enriched
          }
          
          watch(
            () => favorites.value,
            (v) => {
              if (v) enrichWithCompany(v)
            },
            { immediate: true }
          )
          
          const removeFromFavorites = async (jobId: string) => {
            try {
              await $fetch('/api/favorites', { method: 'DELETE', body: { jobId } })
              $notify('Видалено з обраного', 'success')
              await refresh()
            } catch (e: any) {
              $notify(e?.data?.statusMessage || 'Не вдалося видалити з обраного', 'error')
            }
          }
          </script>
          
          <template>
            <section class="space-y-6">
              <div>
                <h1 class="text-2xl font-semibold text-primary">Обране</h1>
                <p class="text-sm text-muted mt-1">Ваші збережені вакансії.</p>
              </div>
          
              <div v-if="pending" class="text-sm text-muted">Завантаження...</div>
          
              <div v-else-if="error" class="text-sm text-red-500">
                {{ (error as any)?.data?.statusMessage || 'Помилка завантаження обраного' }}
              </div>
          
              <div v-else class="space-y-3">
                <div v-if="!items.length" class="text-sm text-muted">Поки що немає обраних вакансій</div>
          
                <div v-for="job in items" :key="job._id" class="space-y-2">
                  <JobCard :job="job" :show-description="true" />
                  <button
                    class="text-xs px-3 py-2 rounded-xl border border-slate-300 hover:border-red-400 hover:text-red-600"
                    @click="removeFromFavorites(job._id)"
                  >
                    Видалити з обраного
                  </button>
                </div>
              </div>
            </section>
          </template>
          EOF

      - name: Commit and push TASK010
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add components/JobCard.vue pages/jobs/index.vue pages/favorites.vue
          git commit -m "TASK010: shared JobCard + favorites show company name and phone" || echo "No changes"
          git push
