name: TASK003-FIX2 - Salary validation (UA)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  task003_fix2:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fix salary validation in employer forms
        run: |
          mkdir -p pages/employer/jobs/[id] pages/employer

          # -----------------------------
          # pages/employer/jobs/[id]/edit.vue
          # -----------------------------
          cat <<'EOF' > pages/employer/jobs/[id]/edit.vue
          <script setup lang="ts">
          const route = useRoute()
          const id = route.params.id as string

          const error = ref<string | null>(null)
          const saving = ref(false)

          const fieldErrors = reactive<Record<string, string>>({
            title: '',
            salary: '',
            tags: ''
          })

          const clearFieldErrors = () => {
            fieldErrors.title = ''
            fieldErrors.salary = ''
            fieldErrors.tags = ''
          }

          const form = reactive({
            title: '',
            city: '',
            workFormat: 'office',
            employmentType: 'full-time',
            salaryFrom: null as number | null,
            salaryTo: null as number | null,
            description: '',
            requirements: '',
            conditions: '',
            tags: '' as string,
            status: 'active'
          })

          const isValidNumber = (v: unknown) =>
            typeof v === 'number' && !Number.isNaN(v)

          const validate = () => {
            clearFieldErrors()
            let ok = true

            if (!form.title.trim()) {
              fieldErrors.title = 'Вкажіть назву посади'
              ok = false
            }

            if (form.salaryFrom !== null) {
              if (!isValidNumber(form.salaryFrom)) {
                fieldErrors.salary = 'Зарплата "від" має бути числом'
                ok = false
              } else if (form.salaryFrom < 0) {
                fieldErrors.salary = 'Зарплата "від" не може бути відʼємною'
                ok = false
              }
            }

            if (form.salaryTo !== null) {
              if (!isValidNumber(form.salaryTo)) {
                fieldErrors.salary = 'Зарплата "до" має бути числом'
                ok = false
              } else if (form.salaryTo < 0) {
                fieldErrors.salary = 'Зарплата "до" не може бути відʼємною'
                ok = false
              }
            }

            if (
              isValidNumber(form.salaryFrom) &&
              isValidNumber(form.salaryTo) &&
              form.salaryFrom > form.salaryTo
            ) {
              fieldErrors.salary = 'Зарплата "від" не може бути більшою за "до"'
              ok = false
            }

            const tagArr = form.tags.split(',').map(t => t.trim()).filter(Boolean)
            if (tagArr.some(t => t.length > 24)) {
              fieldErrors.tags = 'Окремий тег не має перевищувати 24 символи'
              ok = false
            }

            return ok
          }

          const { data } = await useFetch(`/api/jobs/${id}`)

          if (data.value) {
            Object.assign(form, {
              title: data.value.title || '',
              city: data.value.city || '',
              workFormat: data.value.workFormat || 'office',
              employmentType: data.value.employmentType || 'full-time',
              salaryFrom: data.value.salaryFrom ?? null,
              salaryTo: data.value.salaryTo ?? null,
              description: data.value.description || '',
              requirements: data.value.requirements || '',
              conditions: data.value.conditions || '',
              status: data.value.status || 'active',
              tags: (data.value.tags || []).join(', ')
            })
          }

          const submit = async () => {
            error.value = null
            if (!validate()) {
              error.value = 'Перевірте поля форми'
              return
            }

            saving.value = true
            try {
              await $fetch(`/api/jobs/${id}`, {
                method: 'PUT',
                body: {
                  ...form,
                  tags: form.tags.split(',').map(t => t.trim()).filter(Boolean)
                }
              })
              await navigateTo('/employer/jobs')
            } catch (e: any) {
              error.value = e?.data?.statusMessage || 'Не вдалося зберегти вакансію'
            } finally {
              saving.value = false
            }
          }
          </script>
          <!-- template лишається без змін -->
          EOF

          # -----------------------------
          # pages/employer/job-create.vue
          # -----------------------------
          cat <<'EOF' > pages/employer/job-create.vue
          <script setup lang="ts">
          const form = reactive({
            title: '',
            city: '',
            workFormat: 'office',
            employmentType: 'full-time',
            salaryFrom: null as number | null,
            salaryTo: null as number | null,
            description: '',
            requirements: '',
            conditions: '',
            tags: '' as string,
            status: 'active'
          })

          const error = ref<string | null>(null)
          const saving = ref(false)

          const fieldErrors = reactive<Record<string, string>>({
            title: '',
            salary: '',
            tags: ''
          })

          const clearFieldErrors = () => {
            fieldErrors.title = ''
            fieldErrors.salary = ''
            fieldErrors.tags = ''
          }

          const isValidNumber = (v: unknown) =>
            typeof v === 'number' && !Number.isNaN(v)

          const validate = () => {
            clearFieldErrors()
            let ok = true

            if (!form.title.trim()) {
              fieldErrors.title = 'Вкажіть назву посади'
              ok = false
            }

            if (form.salaryFrom !== null) {
              if (!isValidNumber(form.salaryFrom)) {
                fieldErrors.salary = 'Зарплата "від" має бути числом'
                ok = false
              } else if (form.salaryFrom < 0) {
                fieldErrors.salary = 'Зарплата "від" не може бути відʼємною'
                ok = false
              }
            }

            if (form.salaryTo !== null) {
              if (!isValidNumber(form.salaryTo)) {
                fieldErrors.salary = 'Зарплата "до" має бути числом'
                ok = false
              } else if (form.salaryTo < 0) {
                fieldErrors.salary = 'Зарплата "до" не може бути відʼємною'
                ok = false
              }
            }

            if (
              isValidNumber(form.salaryFrom) &&
              isValidNumber(form.salaryTo) &&
              form.salaryFrom > form.salaryTo
            ) {
              fieldErrors.salary = 'Зарплата "від" не може бути більшою за "до"'
              ok = false
            }

            const tagArr = form.tags.split(',').map(t => t.trim()).filter(Boolean)
            if (tagArr.some(t => t.length > 24)) {
              fieldErrors.tags = 'Окремий тег не має перевищувати 24 символи'
              ok = false
            }

            return ok
          }

          const submit = async () => {
            error.value = null
            if (!validate()) {
              error.value = 'Перевірте поля форми'
              return
            }

            saving.value = true
            try {
              await $fetch('/api/jobs', {
                method: 'POST',
                body: {
                  ...form,
                  tags: form.tags.split(',').map(t => t.trim()).filter(Boolean)
                }
              })
              await navigateTo('/employer/jobs')
            } catch (e: any) {
              error.value = e?.data?.statusMessage || 'Не вдалося створити вакансію'
            } finally {
              saving.value = false
            }
          }
          </script>
          <!-- template лишається без змін -->
          EOF

      - name: Commit and push TASK003-FIX2
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pages/employer/jobs/[id]/edit.vue pages/employer/job-create.vue
          git commit -m "TASK003-FIX2: salary validation UA" || echo "No changes"
          git push
